<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Classificaci贸 - Club de Pesca Torres de Segre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Classificaci贸 oficial del Club de Pesca Torres de Segre."/>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

<header>
  <div class="container">
    <nav>
      <div class="logo"> Club de Pesca Torres de Segre</div>
      <div class="nav-links">
        <a href="index.html">Inici</a>
        <a href="classificacio.html" class="active">Classificaci贸</a>
        <a href="calendari.html">Calendari</a>
        <a href="normes.html">Normes</a>
        <a href="botiga.html">Botiga</a>
        <a href="galeria.html">Galeria</a>
        <a href="contacte.html">Contacte</a>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="table-top">
      <div>
        <h1>Classificaci贸 final</h1>
        <p class="descripcio">Punts totals acumulats (fi de temporada).</p>
      </div>

      <div class="table-actions">
        <input id="q" type="search" placeholder="Cercar pescador..." aria-label="Cercar" />
        <button id="toggleSort" title="Ordenar per punts / posici贸">Ordena per punts</button>
      </div>
    </div>

    <div class="table-wrap" role="region" aria-label="Taula de classificaci贸" tabindex="0">
      <table class="pro-table" id="table">
        <thead>
          <tr>
            <th data-col="pos">P</th>
            <th data-col="nom">Nom</th>
            <th data-col="punts">Puntuaci贸 final</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  Club de Pesca Torres de Segre 路 Lliga Individual 2025
</footer>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZr7Rh9h9mnykdAranLV3Z1p3PErucd-qZOBpxYMOqrA-xfAXxmRkL1zKHOWB2vsYSwcXnkf1DR-U/pub?output=csv";

const tbody = document.getElementById("rows");
const q = document.getElementById("q");
const toggleSort = document.getElementById("toggleSort");

let data = [];
let sortByPoints = false;

// Parser CSV (respecta cometes i detecta separador)
function parseCSV(text){
  const lines = text.replace(/\r/g, "").trim().split("\n");
  if (!lines.length) return [];

  // detecta separador: coma o punt i coma
  const header = lines[0];
  const sep = (header.split(";").length > header.split(",").length) ? ";" : ",";

  const parseLine = (line) => {
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') inQ = !inQ;
      else if (ch === sep && !inQ){ out.push(cur); cur=""; }
      else cur += ch;
    }
    out.push(cur);
    return out.map(s => s.replaceAll('"','').trim());
  };

  const rows = lines.slice(1).map(parseLine);

  return rows
    .filter(cols => cols.some(c => c !== "")) // elimina l铆nies buides
    .map(cols => ({
      pos: Number(cols[0]) || 0,
      nom: (cols[1] || "").trim(),
      punts: Number(cols[2]) || 0
    }));
}

function render(){
  const query = (q.value || "").toLowerCase().trim();

  let rows = data.filter(r => (r.nom || "").toLowerCase().includes(query));

  rows.sort((a,b) => {
    if (sortByPoints) return (b.punts - a.punts) || (a.pos - b.pos);
    return a.pos - b.pos;
  });

  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="3" style="padding:14px;opacity:.8">
      No hi ha dades (revisa que el full estigui publicat i el CSV sigui accessible).
    </td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><strong>${r.pos}</strong></td>
      <td>${escapeHtml(r.nom)}</td>
      <td><strong>${r.punts}</strong></td>
    </tr>
  `).join("");
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function init(){
  try{
    const res = await fetch(csvUrl, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const text = await res.text();
    data = parseCSV(text);
    render();
  } catch(e){
    console.error("Error carregant CSV:", e);
    tbody.innerHTML = `<tr><td colspan="3" style="padding:14px;color:#ffb3b3">
      Error carregant dades del full (mira la consola F12). ${escapeHtml(e.message)}
    </td></tr>`;
  }
}

q.addEventListener("input", render);

toggleSort.addEventListener("click", () => {
  sortByPoints = !sortByPoints;
  toggleSort.textContent = sortByPoints ? "Ordena per posici贸" : "Ordena per punts";
  render();
});

// recrrega automtica cada 2 minuts (opcional)
setInterval(init, 120000);

init();
</script>




</body>
</html>
