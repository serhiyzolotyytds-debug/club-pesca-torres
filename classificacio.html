<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>ClassificaciÃ³ - Club de Pesca Torres de Segre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ClassificaciÃ³ oficial del Club de Pesca Torres de Segre."/>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css?v=3" />
</head>

<body>

<header>
  <div class="container">
    <nav>
      <div class="logo">ðŸŽ£ Club de Pesca Torres de Segre</div>
      <div class="nav-links">
        <a href="index.html">Inici</a>
        <a href="classificacio.html" class="active">ClassificaciÃ³</a>
        <a href="calendari.html">Calendari</a>
        <a href="normes.html">Normes</a>
        <a href="botiga.html">Botiga</a>
        <a href="galeria.html">Galeria</a>
        <a href="contacte.html">Contacte</a>
        <a class="nav-cta" href="contacte.html">Inscripcions</a>
      
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="table-top">
      <div>
        <h1>ClassificaciÃ³ final</h1>
        <p class="descripcio">Punts totals acumulats (fi de temporada).</p>
      </div>

      <div class="table-actions">
        <input id="q" type="search" placeholder="Cercar pescador..." aria-label="Cercar" />
        <button id="toggleSort" class="btn-soft" title="Ordenar per punts / posiciÃ³">Ordena per punts</button>
      </div>
      <select id="sheetSelect" class="sheet-select">
      </select>
    </div>

    <div class="notice" id="status" aria-live="polite"></div>

    <div class="table-wrap" role="region" aria-label="Taula de classificaciÃ³" tabindex="0">
      <table class="pro-table league-table" id="table">
        <thead id="thead"></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <div class="footer-col">
      <div class="footer-brand">ðŸŽ£ Club de Pesca Torres de Segre</div>
      <p class="footer-note">Lliga oficial Â· captura i alliberament Â· escenaris de la zona.</p>
      <div class="footer-badges">
        <span class="pill">Captura &amp; alliberament</span>
        <span class="pill">CompeticiÃ³ individual</span>
      </div>
    </div>

    <div class="footer-col">
      <div class="footer-title">EnllaÃ§os</div>
      <a href="classificacio.html">ClassificaciÃ³</a>
      <a href="calendari.html">Calendari</a>
      <a href="normes.html">Normes</a>
      <a href="galeria.html">Galeria</a>
      <a href="botiga.html">Botiga</a>
      <a href="contacte.html">Contacte</a>
    </div>

    <div class="footer-col">
      <div class="footer-title">Contacte</div>
      <p class="footer-line"><strong>Correu:</strong> clubpescatorresdesegre@gmail.com</p>
      <p class="footer-line"><strong>Zona:</strong> Torres de Segre Â· Utxesa Â· Segreâ€“Cinca</p>
      <div class="footer-actions">
        <a class="btn primary" href="contacte.html">Inscripcions</a>
        <a class="btn ghost" href="botiga.html">Botiga</a>
      </div>
    </div>
  </div>

  <div class="container footer-bottom">
    <span>Â© <span id="y"></span> Club de Pesca Torres de Segre</span>
    <span class="sep">Â·</span>
    <span>Disseny web estÃ tica (GitHub Pages)</span>
  </div>
</footer>
<script>document.getElementById("y").textContent=new Date().getFullYear();</script>

<script>
/** ====== CONFIG ======
 *  Posa aquÃ­ el teu Sheet ID i el GID de la pestanya (ja te'l deixo preparat).
 */
const SHEET_ID = "19E7UR9NOwXsJEPvtA0gyBtxeqC-T6-fML9LzM7mL53Q";

const SHEETS = [
  { name: "Fi de temporada", gid: "270978965" },
  { name: "Open Utxesa I", gid: "929110041" },
  { name: "Open Utxesa II", gid: "2078448821" },
  { name: "Open Riba-roja d'Ebre", gid: "1575215359" },
  { name: "Open La Granja d'Escarp", gid: "153695030" },
  { name: "Open Oliana", gid: "0" },
  { name: "Social I", gid: "1532939452" },
  { name: "Social II", gid: "2124626822" },
  { name: "Social III", gid: "2128758368" },
  { name: "Social IV", gid: "2036729983" },
  { name: "Festa de el Pescador", gid: "1516179934" },
];

function csvUrlFor(gid){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
}
const select = document.getElementById("sheetSelect");

// Omplir el desplegable
SHEETS.forEach((s, i) => {
  const opt = document.createElement("option");
  opt.value = s.gid;
  opt.textContent = s.name;
  if (i === 0) opt.selected = true;
  select.appendChild(opt);
});

async function reloadCurrent(){
  try{
    state.raw = await loadData(select.value);
    buildHead();
    updateToggleText();
    render();
  } catch (e){
    console.error("Error carregant dades:", e);
    setStatus(`Error carregant dades del full. ${e.message || e}`, "error");
  }
}

// Quan canvies la competiciÃ³
select.addEventListener("change", reloadCurrent);

/** ====== CSV PARSER (sense llibreries) ====== */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' ){
      if (inQuotes && next === '"'){ // cometes escapades
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && c === ','){
      row.push(cur);
      cur = "";
      continue;
    }

    if (!inQuotes && (c === '\n' || c === '\r')){
      if (c === '\r' && next === '\n') i++; // CRLF
      row.push(cur);
      cur = "";
      // Evita afegir files buides finals
      if (row.some(v => String(v).trim() !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += c;
  }

  // Ãºltima celÂ·la
  row.push(cur);
  if (row.some(v => String(v).trim() !== "")) rows.push(row);

  return rows;
}

function normalizeHeader(h){
  return String(h || "")
    .trim()
    .toLowerCase()
    .replaceAll("Ã ","a").replaceAll("Ã¡","a")
    .replaceAll("Ã¨","e").replaceAll("Ã©","e")
    .replaceAll("Ã­","i")
    .replaceAll("Ã²","o").replaceAll("Ã³","o")
    .replaceAll("Ãº","u")
    .replaceAll("Â·","")
    .replaceAll(".","")
    .replaceAll("-"," ")
    .replaceAll("_"," ")
    .replace(/\s+/g," ");
}

function toNumber(v){
  const n = Number(String(v ?? "").replace(",", ".").trim());
  return Number.isFinite(n) ? n : null;
}

const state = {
  raw: [],
  filtered: [],
  sortBy: "pos", // "pos" o "punts"
  columns: [] // {key,label}
};

const elRows = document.getElementById("rows");
const elHead = document.getElementById("thead");
const elQ = document.getElementById("q");
const elToggle = document.getElementById("toggleSort");
const elStatus = document.getElementById("status");

function setStatus(msg, type="info"){
  elStatus.textContent = msg;
  elStatus.className = "notice notice--" + type;
}

async function loadData(gid){
  setStatus("Carregant classificaciÃ³â€¦", "info");
  const url = csvUrlFor(gid);

  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();

  const table = parseCSV(text);
  if (!table.length) return [];

  // ðŸ”Ž Troba automÃ ticament la fila de capÃ§alera (per fulls que tenen tÃ­tols a dalt)
  let headerRowIndex = 0;
  let headers = table[0];

  const wanted = ["nom", "punts", "puntuacio", "puntuacio final", "posicio", "posiciÃ³"];
  for (let r = 0; r < Math.min(10, table.length); r++){
    const row = table[r].map(normalizeHeader);
    const hits = wanted.filter(w => row.includes(normalizeHeader(w))).length;
    if (hits >= 2){ headerRowIndex = r; headers = table[r]; break; }
  }

  const body = table.slice(headerRowIndex + 1);

  // Map de columnes pel nom
  const idx = new Map();
  headers.forEach((h, i) => idx.set(normalizeHeader(h), i));

  const candidates = [
    { key:"pos", labels:["p","pos","posicio","posiciÃ³"], fallbackIndex:0 },
    { key:"nom", labels:["nom","pescador","participant"], fallbackIndex:1 },
    { key:"punts", labels:["punts","puntuacio","puntuaciÃ³","puntuacio final","puntuaciÃ³ final","total"], fallbackIndex:2 },
    { key:"coeficient", labels:["coeficient","coef","coef."], optional:true },
    { key:"j", labels:["j","partits","pj"], optional:true },
    { key:"g", labels:["g","guanyats","pg"], optional:true },
    { key:"e", labels:["e","empats","pe"], optional:true },
    { key:"p", labels:["p","perduts","pp"], optional:true },
    { key:"gf", labels:["gf","f","favor"], optional:true },
    { key:"gc", labels:["gc","c","contra"], optional:true },
    { key:"ultims", labels:["ultims","Ãºltims","forma"], optional:true }
  ];

  function findIndexFor(c){
    for (const l of c.labels){
      const k = normalizeHeader(l);
      if (idx.has(k)) return idx.get(k);
    }
    if (c.fallbackIndex != null && c.fallbackIndex < headers.length) return c.fallbackIndex;
    return null;
  }

  const colIndex = {};
  for (const c of candidates){
    const i = findIndexFor(c);
    if (i == null){
      if (!c.optional) throw new Error("No trobo les columnes mÃ­nimes (pos/nom/punts) al Google Sheets.");
    } else {
      colIndex[c.key] = i;
    }
  }

  const visible = [
    {key:"pos", label:"P"},
    {key:"nom", label:"NOM"},
    {key:"punts", label:"PUNTS"}
  ];

  const extraOrder = [
    {key:"coeficient", label:"COEF."},
    {key:"j", label:"J"},
    {key:"g", label:"G"},
    {key:"e", label:"E"},
    {key:"p", label:"P"},
    {key:"gf", label:"F"},
    {key:"gc", label:"C"},
    {key:"ultims", label:"ÃšLTIMS"}
  ];
  for (const ex of extraOrder){
    if (colIndex[ex.key] != null) visible.push(ex);
  }

  const data = body.map(r => {
    const obj = {};
    for (const col of visible){
      const i = colIndex[col.key];
      obj[col.key] = (i != null ? (r[i] ?? "") : "");
    }
    obj.posNum = toNumber(obj.pos);
    obj.puntsNum = toNumber(obj.punts);
    return obj;
  })
  // âœ… filtra files â€œbonesâ€: nom no buit i punts numÃ¨rics
  .filter(o => String(o.nom || "").trim() !== "" && (o.puntsNum != null));

  state.columns = visible;
  return data;
}

function buildHead(){
  const tr = document.createElement("tr");
  for (const col of state.columns){
    const th = document.createElement("th");
    th.textContent = col.label;

    if (col.key === "pos" || col.key === "punts"){
      th.classList.add("is-sortable");
      th.title = "Clica per ordenar";
      th.addEventListener("click", () => {
        state.sortBy = (col.key === "pos") ? "pos" : "punts";
        updateToggleText();
        render();
      });
    }

    tr.appendChild(th);
  }
  elHead.innerHTML = "";
  elHead.appendChild(tr);
}


function applyFilter(){
  const q = elQ.value.trim().toLowerCase();
  if (!q){
    state.filtered = [...state.raw];
    return;
  }
  state.filtered = state.raw.filter(r => String(r.nom || "").toLowerCase().includes(q));
}

function applySort(){
  const by = state.sortBy;
  const arr = [...state.filtered];

  if (by === "punts"){
    arr.sort((a,b) => (b.puntsNum ?? -Infinity) - (a.puntsNum ?? -Infinity));
  } else {
    arr.sort((a,b) => (a.posNum ?? Infinity) - (b.posNum ?? Infinity));
  }

  // Recalcula posiciÃ³ si ordenem per punts
  if (by === "punts"){
    arr.forEach((r, i) => { r._renderPos = i + 1; });
  } else {
    arr.forEach(r => { r._renderPos = r.posNum ?? ""; });
  }

  state.filtered = arr;
}

function render(){
  applyFilter();
  applySort();

  elRows.innerHTML = "";

  for (const r of state.filtered){
    const tr = document.createElement("tr");

    for (const col of state.columns){
      const td = document.createElement("td");

      if (col.key === "pos"){
        td.textContent = r._renderPos ?? r.pos ?? "";
        td.classList.add("col-pos");
      } else if (col.key === "ultims"){
        td.appendChild(renderForm(r[col.key]));
      } else {
        td.textContent = String(r[col.key] ?? "").trim();
      }

      tr.appendChild(td);
    }

    elRows.appendChild(tr);
  }

  setStatus(
    state.filtered.length
      ? `Mostrant ${state.filtered.length} registre(s).`
      : "No hi ha resultats amb aquest filtre.",
    state.filtered.length ? "ok" : "warn"
  );
}

function renderForm(value){
  const wrap = document.createElement("div");
  wrap.className = "form-chips";

  // Accepta formats: "E G E P G" o "E,G,E,P,G" o "EGEPG"
  const raw = String(value ?? "").trim();
  if (!raw) return wrap;

  let items = raw.split(/\s+|,|\|/).filter(Boolean);
  if (items.length === 1 && items[0].length > 1){
    items = items[0].split("");
  }

  for (const it of items.slice(0,5)){
    const s = it.trim().toUpperCase();
    const chip = document.createElement("span");
    chip.className = "chip chip--" + s;
    chip.textContent = s;
    wrap.appendChild(chip);
  }
  return wrap;
}

function updateToggleText(){
  elToggle.textContent = (state.sortBy === "punts") ? "Ordena per posiciÃ³" : "Ordena per punts";
}

elQ.addEventListener("input", () => render());
elToggle.addEventListener("click", () => {
  state.sortBy = (state.sortBy === "pos") ? "punts" : "pos";
  updateToggleText();
  render();
});

(async function init(){
  updateToggleText();
  await reloadCurrent();
})();

</script>

</body>
</html>
